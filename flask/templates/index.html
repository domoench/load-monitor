<!DOCTYPE html>
<meta charset='utf-8'>
<html>
  <head>
    <title>CPU Load Monitor</title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='http://d3js.org/d3.v3.min.js'></script>
  </head>

  <style>
    .axis text {
      font: 10px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }
  </style>

  <body>
    <h1>Stats</h1>
    Uptime: <span id='uptime'></span><br>
    10-min Average Load: <span id='ten-min-avg'></span><br>
    10-min Average Median: <span id='ten-min-med'></span><br>
    Min Load: <span id='min-load'></span><br>
    Max Load: <span id='max-load'></span><br>
    Alerts:
    <ul id='alerts'>
    </ul>
    10-Minute History:
    <ul id='history'>
    </ul>

    <svg id='bar-graph'></svg>

    <script>
      refresh();

      function poll(){
        setTimeout(refresh, 10000); 
      };

      function refresh() {
        $.ajax({
          url: 'http://localhost:5000/state', 
          dataType: 'json',
          success: function(data) {
            // Note: data is already parsed into a JS object
            handleData(data);
            poll();
          }});
      }

      function handleData(data) {
        $('#uptime').html(data.uptime + ' mins');
        $('#ten-min-avg').html(data.tenMinAvg.toFixed(2));
        $('#ten-min-med').html(data.tenMinMed.toFixed(2));
        $('#min-load').html(data.minLoad.toFixed(2));
        $('#max-load').html(data.maxLoad.toFixed(2));
        
        // Display Alert History
        var a_list = $('ul#alerts');
        a_list.html('')
        $.each(data.alertHistory, function(i) {
          var alert_entry    = data.alertHistory[i],
              alert_time     = alert_entry[0],
              alert_high     = alert_entry[1],
              alert_load_avg = alert_entry[2].toFixed(2),
              li = $('<li/>'),
              alert_string = '';

          if (alert_high) {
            alert_string = 'High Load Alert! ';
          }
          else {
            alert_string = 'Load Recovered! ';
          }
          alert_time = new Date(alert_time * 1000);
          alert_time = alert_time.toLocaleTimeString();
          alert_string += '2-minute Load Average: ' + alert_load_avg + ', Triggered at ' 
                          + alert_time;
          li.text(alert_string);
          li.appendTo(a_list);
        });

        // Display History
        /*
        var h_list = $('ul#history');
        h_list.html('')
        $.each(data.history, function(i) {
            var li = $('<li/>').text(data.history[i][1].toFixed(2));
            li.appendTo(h_list);
        });
        */

        drawBarGraph(data);
      }

      function drawBarGraph(data) {
        console.log('drawing');
        var history = [];
        for (var i = 0; i < data.history.length; ++i) {
          history.push({x: i * 10, y: data.history[i][1]});
        }

        var time_steps = [];
        for (var i = 0; i < 600; i += 10) {
          time_steps.push(i);
        }

        var margin = {top: 20, right: 30, bottom: 40, left: 30},
            width  = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
                .domain(time_steps)
                .rangeRoundBands([0, width], .1);

        var y = d3.scale.linear()
                .domain([0, 3])
                .range([height, 0]);

        var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient('bottom')
                    .tickValues([0, 60, 120, 180, 240, 300, 360, 420, 480, 540]);

        var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient('left');

        var chart = d3.select('#bar-graph')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.bottom + margin.top)
                  .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        d3.select('#bar-graph').selectAll('text').remove();
        d3.select('#bar-graph').selectAll('rect').remove();

        var barData = chart.selectAll('.bar').data(history);

        var cScale = d3.scale.linear()
                     .domain([0.0, 0.5, 1.0, 2.5])
                     .range(['#67E400','#67E400','#FF9C00', '#FF0D00']);
                     
        barData.enter().append('rect')
               .attr('class', 'bar')
               .attr('x', function(d) { return x(d.x); })
               .attr('y', function(d) { return y(d.y); })
               .attr('height', function(d) { return height - y(d.y); })
               .attr('width', x.rangeBand())
               .style('fill', function(d) { return cScale(d.y); });

        chart.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
          .append('text') 
            .attr("y", 30)
            .attr("x", 49)
            .style("text-anchor", "begining")
            .text("Seconds Ago");

        chart.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append('text') 
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .style("text-anchor", "end")
            .text("CPU Load Average");
            

      }
    </script>
  </body>

</html>
