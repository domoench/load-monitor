<!DOCTYPE html>
<meta charset='utf-8'>
<html>
  <head>
    <title>CPU Load Monitor</title>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script src='http://d3js.org/d3.v3.min.js'></script>
  </head>

  <style>
  .bar {
  fill: steelblue;
  }

  .axis text {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .x.axis path {
    display: none;
  }
  </style>

  <body>
    <h1>Stats</h1>
    Uptime: <span id='uptime'></span><br>
    10-min Average Load: <span id='ten-min-avg'></span><br>
    10-min Average Median: <span id='ten-min-med'></span><br>
    Min Load: <span id='min-load'></span><br>
    Max Load: <span id='max-load'></span><br>
    Alerts:
    <ul id='alerts'>
    </ul>
    10-Minute History:
    <ul id='history'>
    </ul>

    <svg id='bar-graph'></svg>

    <script>
      refresh();

      function poll(){
        setTimeout(refresh, 10000); 
      };

      function refresh() {
        $.ajax({
          url: 'http://localhost:5000/state', 
          dataType: 'json',
          success: function(data) {
            // Note: data is already parsed into a JS object
            handleData(data);
            poll();
          }});
      }

      function handleData(data) {
        $('#uptime').html(data.uptime + ' mins');
        $('#ten-min-avg').html(data.tenMinAvg.toFixed(2));
        $('#ten-min-med').html(data.tenMinMed.toFixed(2));
        $('#min-load').html(data.minLoad.toFixed(2));
        $('#max-load').html(data.maxLoad.toFixed(2));
        
        // Display Alert History
        var a_list = $('ul#alerts');
        a_list.html('')
        $.each(data.alertHistory, function(i) {
          var alert_entry    = data.alertHistory[i],
              alert_time     = alert_entry[0],
              alert_high     = alert_entry[1],
              alert_load_avg = alert_entry[2].toFixed(2),
              li = $('<li/>'),
              alert_string = '';

          if (alert_high) {
            alert_string = 'High Load Alert! ';
          }
          else {
            alert_string = 'Load Recovered! ';
          }
          alert_time = new Date(alert_time * 1000);
          alert_time = alert_time.toLocaleTimeString();
          alert_string += '2-minute Load Average: ' + alert_load_avg + ', Triggered at ' 
                          + alert_time;
          li.text(alert_string);
          li.appendTo(a_list);
        });

        // Display History
        /*
        var h_list = $('ul#history');
        h_list.html('')
        $.each(data.history, function(i) {
            var li = $('<li/>').text(data.history[i][1].toFixed(2));
            li.appendTo(h_list);
        });
        */

        drawBarGraph(data);
      }

      function drawBarGraph(data) {
        console.log('drawing');
        var history = [];
        for (var i = 0; i < data.history.length; ++i) {
          history.push(data.history[i][1]);
        }

        var width  = 960,
            height = 500;

        var y = d3.scale.linear()
                .range([height, 0]);

        var chart = d3.select('#bar-graph')
                    .attr('width', width)
                    .attr('height', height);

        y.domain([0, d3.max(history, function(d) { return d; })]);

        var barWidth = width / 60.0;

        chart.selectAll("g").remove();

        var bar = chart.selectAll("g")
                  .data(history)
                  .enter().append("g")
                  .attr("transform", function(d, i) { 
                    return "translate(" + i * barWidth + ",0)"; 
                  });

        bar.append("rect")
          .attr("y", function(d) { return y(d); })
          .attr("height", function(d) { return height - y(d); })
          .attr("width", barWidth - 1);

        function type(d) {
          d.value = +d.value; // coerce to number
          return d;
        }
      }
    </script>
  </body>

</html>
